<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Brands - Toy Tap</title>
    <meta name="description" content="Browse toys by brand. LEGO, Fisher-Price, Melissa & Doug, and more." />
    <link rel="icon" type="image/png" href="https://i.imgur.com/HXSawxU.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3fc3d5",
                        "background-dark": "#0a0e27",
                        "navy-deep": "#0a0e27",
                        "navy-card": "#12183d",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"]
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .cyan-glow { box-shadow: 0 0 20px rgba(63, 195, 213, 0.3); }
        .glass-panel { background: rgba(18, 24, 61, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .glass-card { background: rgba(18, 24, 61, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .filter-tab { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .filter-tab:hover { background: rgba(63,195,213,0.1); color: white; }
        .filter-tab.active { background: linear-gradient(135deg, #3fc3d5, #0a0e27); color: white; border-color: #3fc3d5; }
    </style>
</head>
<body class="bg-background-dark font-display text-white min-h-screen">
    <!-- Background Effects -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-primary/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] bg-primary/5 rounded-full blur-[100px]"></div>
    </div>

    <!-- Navigation -->
    <header class="relative z-50 border-b border-white/5 bg-navy-deep/80 backdrop-blur-md sticky top-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8 md:h-10 md:w-10" />
                <span class="text-xl md:text-2xl font-black tracking-tighter">Toy Tap</span>
            </a>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-primary" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="watchlist.html">Watchlist</a>
            </nav>
            <div class="flex items-center gap-2 md:gap-4">
                <a href="login.html" class="text-sm font-bold text-white/70 hover:text-primary transition-colors px-3 py-2">Login</a>
                <a href="login.html" class="bg-primary text-navy-deep px-4 md:px-6 py-2.5 rounded-lg font-bold text-sm hover:brightness-110 transition-all hidden md:block">Sign Up</a>
            </div>
        </div>
    </header>

    <main class="relative z-10">
        <!-- Hero -->
        <section class="text-center py-12 md:py-16 px-4">
            <h1 class="text-4xl md:text-6xl font-black text-white mb-4">Shop by Brand</h1>
            <p class="text-white/60 text-lg">Browse toys from your favorite brands</p>
        </section>

        <!-- Content Area -->
        <section class="max-w-7xl mx-auto px-4 md:px-6 pb-12">
            <!-- Brand Grid View -->
            <div id="brands-view">
                <div id="brands-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>

            <!-- Brand Detail View -->
            <div id="brand-detail" class="hidden">
                <!-- Brand Header with Logo -->
                <div class="flex items-center justify-between flex-wrap gap-4 mb-6 pb-6 border-b border-white/10">
                    <div class="flex items-center gap-4">
                        <button onclick="showAllBrands()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white/70 hover:bg-primary/20 hover:text-primary transition-all">
                            <span class="material-symbols-outlined text-lg">arrow_back</span> All Brands
                        </button>
                        <div class="flex items-center gap-3">
                            <img id="brand-logo" src="" alt="" class="w-12 h-12 rounded-lg bg-white object-contain p-1" onerror="this.style.display='none'"/>
                            <h2 id="brand-title" class="text-2xl md:text-3xl font-bold"></h2>
                        </div>
                    </div>
                    <div class="flex gap-6 font-mono">
                        <div class="text-center">
                            <p id="brand-toy-count" class="text-2xl font-bold text-primary">0</p>
                            <p class="text-xs text-white/50">Toys</p>
                        </div>
                        <div class="text-center">
                            <p id="brand-deal-count" class="text-2xl font-bold text-emerald-400">0</p>
                            <p class="text-xs text-white/50">On Sale</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="filter-tab active px-4 py-2 rounded-lg text-sm font-semibold" data-filter="picks" onclick="setFilter('picks')">
                        <span class="material-symbols-outlined text-base align-middle mr-1">star</span> Toy Tap Picks
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="bestsellers" onclick="setFilter('bestsellers')">
                        <span class="material-symbols-outlined text-base align-middle mr-1">trending_up</span> Best Sellers
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="deals" onclick="setFilter('deals')">
                        <span class="material-symbols-outlined text-base align-middle mr-1">local_offer</span> Price Drops
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="toprated" onclick="setFilter('toprated')">
                        <span class="material-symbols-outlined text-base align-middle mr-1">thumb_up</span> Top Rated
                    </button>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <p class="text-white/50 text-sm">Showing <span class="text-white font-semibold" id="showing-count">0</span> toys</p>
                    <select id="sort-select" onchange="handleSortChange()" class="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm text-white/70 focus:outline-none focus:border-primary">
                        <option value="score">Best Value</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                </div>

                <div id="toy-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>

                <div class="text-center mt-10">
                    <button id="show-more-btn" onclick="showMore()" class="hidden bg-white/5 hover:bg-white/10 border border-white/10 text-white font-semibold px-8 py-3 rounded-xl transition-all">
                        Show More
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 bg-navy-deep/40">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-2">
                    <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8" />
                    <span class="text-lg font-bold">Toy Tap</span>
                </div>
                <p class="text-white/30 text-sm">¬© 2025 Toy Tap. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        const TRACKED_BRANDS = [
            { name: 'LEGO', icon: 'üß±', logo: 'https://logo.clearbit.com/lego.com' },
            { name: 'Fisher-Price', icon: 'üë∂', logo: 'https://logo.clearbit.com/fisher-price.com' },
            { name: 'Melissa & Doug', icon: 'üé®', logo: 'https://logo.clearbit.com/melissaanddoug.com' },
            { name: 'VTech', icon: 'üîä', logo: 'https://logo.clearbit.com/vtechkids.com' },
            { name: 'Play-Doh', icon: 'üé≠', logo: 'https://logo.clearbit.com/hasbro.com' },
            { name: 'Hot Wheels', icon: 'üèéÔ∏è', logo: 'https://logo.clearbit.com/hotwheels.mattel.com' },
            { name: 'Barbie', icon: 'üë±‚Äç‚ôÄÔ∏è', logo: 'https://logo.clearbit.com/barbie.mattel.com' },
            { name: 'MAGNA-TILES', icon: 'üî∑', logo: 'https://logo.clearbit.com/magnatiles.com' },
            { name: 'PicassoTiles', icon: 'üî∂', logo: 'https://logo.clearbit.com/picassotiles.com' },
            { name: 'Green Toys', icon: '‚ôªÔ∏è', logo: 'https://logo.clearbit.com/greentoys.com' },
            { name: 'Hape', icon: 'ü™µ', logo: 'https://logo.clearbit.com/hapetoys.com' },
            { name: 'Little Tikes', icon: 'üè†', logo: 'https://logo.clearbit.com/littletikes.com' },
            { name: 'Step2', icon: 'üé¢', logo: 'https://logo.clearbit.com/step2.com' },
            { name: 'KidKraft', icon: 'üè°', logo: 'https://logo.clearbit.com/kidkraft.com' },
            { name: 'LeapFrog', icon: 'üê∏', logo: 'https://logo.clearbit.com/leapfrog.com' },
            { name: 'Learning Resources', icon: 'üìö', logo: 'https://logo.clearbit.com/learningresources.com' },
            { name: 'Skillmatics', icon: 'üß©', logo: 'https://logo.clearbit.com/skillmatics.com' },
            { name: 'Snap Circuits', icon: '‚ö°', logo: 'https://logo.clearbit.com/elenco.com' },
            { name: 'BRIO', icon: 'üöÇ', logo: 'https://logo.clearbit.com/brio.net' },
            { name: 'Infantino', icon: 'üçº', logo: 'https://logo.clearbit.com/infantino.com' },
            { name: 'Playmags', icon: 'üß≤', logo: 'https://logo.clearbit.com/playmags.com' },
            { name: 'Spirograph', icon: 'üåÄ', logo: 'https://logo.clearbit.com/playmonster.com' },
            { name: 'CATAN', icon: 'üèùÔ∏è', logo: 'https://logo.clearbit.com/catan.com' }
        ];

        let currentBrand = null;
        let brandToys = [];
        let filteredToys = [];
        let visibleCount = 24;
        let currentSort = 'score';
        let currentFilter = 'picks';

        document.addEventListener('DOMContentLoaded', () => {
            const urlBrand = getUrlParam('brand');
            if (urlBrand) {
                selectBrand(urlBrand);
            } else {
                renderBrandsGrid();
            }
        });

        function renderBrandsGrid() {
            document.getElementById('brands-grid').innerHTML = TRACKED_BRANDS.map(brand => `
                <button onclick="selectBrand('${brand.name}')" class="glass-card rounded-xl p-6 text-center hover:border-primary/30 hover:scale-105 transition-all group">
                    <div class="w-16 h-16 mx-auto mb-3 rounded-xl bg-white flex items-center justify-center overflow-hidden">
                        <img src="${brand.logo}" alt="${brand.name}" class="w-12 h-12 object-contain" onerror="this.parentElement.innerHTML='<span class=\\'text-3xl\\'>${brand.icon}</span>'"/>
                    </div>
                    <p class="font-semibold text-white">${brand.name}</p>
                    <p class="text-primary text-sm mt-1 group-hover:underline">View toys ‚Üí</p>
                </button>
            `).join('');
        }

        async function selectBrand(brandName) {
            currentBrand = brandName;
            visibleCount = 24;
            currentSort = 'score';
            currentFilter = 'picks';

            // Reset filter tabs
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-filter="picks"]').classList.add('active');

            history.pushState({}, '', `brands.html?brand=${encodeURIComponent(brandName)}`);

            document.getElementById('brands-view').classList.add('hidden');
            document.getElementById('brand-detail').classList.remove('hidden');
            document.getElementById('brand-title').textContent = brandName;

            // Set brand logo
            const brandInfo = TRACKED_BRANDS.find(b => b.name === brandName);
            const logoEl = document.getElementById('brand-logo');
            if (brandInfo && brandInfo.logo) {
                logoEl.src = brandInfo.logo;
                logoEl.style.display = 'block';
            } else {
                logoEl.style.display = 'none';
            }

            document.getElementById('toy-grid').innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-20">
                    <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
                    <p class="text-white/50">Loading ${brandName} toys...</p>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/toys/brand/${encodeURIComponent(brandName)}?limit=200&sort=toy_tap_rank`);
                const data = await res.json();
                brandToys = data.toys || [];

                document.getElementById('brand-toy-count').textContent = brandToys.length;
                document.getElementById('brand-deal-count').textContent = brandToys.filter(t => parseFloat(t.discount_percent) > 10).length;

                applyFilterAndRender();
            } catch (err) {
                console.error('Error loading brand:', err);
                document.getElementById('toy-grid').innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <p class="text-red-400 mb-4">Failed to load toys</p>
                        <button onclick="selectBrand('${brandName}')" class="bg-primary text-navy-deep px-6 py-2 rounded-lg font-semibold">Retry</button>
                    </div>
                `;
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            visibleCount = 24;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.filter === filter);
            });

            applyFilterAndRender();
        }

        function applyFilterAndRender() {
            // Apply filter
            switch (currentFilter) {
                case 'picks':
                    // Toy Tap Picks - high TT Grade score
                    filteredToys = brandToys.filter(t => t.tt_grade && ['S', 'A+', 'A'].includes(t.tt_grade));
                    if (filteredToys.length < 5) filteredToys = [...brandToys]; // Fallback to all if not enough
                    break;
                case 'bestsellers':
                    // Best Sellers - sorted by Amazon rank (lower is better)
                    filteredToys = [...brandToys].sort((a, b) => (parseInt(a.rank) || 999999) - (parseInt(b.rank) || 999999));
                    break;
                case 'deals':
                    // Price Drops - has discount
                    filteredToys = brandToys.filter(t => parseFloat(t.discount_percent) > 5);
                    break;
                case 'toprated':
                    // Top Rated - high rating with decent reviews
                    filteredToys = brandToys.filter(t => parseFloat(t.rating) >= 4.5 && parseInt(t.reviews_count) >= 50);
                    if (filteredToys.length < 5) filteredToys = brandToys.filter(t => parseFloat(t.rating) >= 4.0);
                    break;
                default:
                    filteredToys = [...brandToys];
            }

            sortAndRender();
        }

        function showAllBrands() {
            currentBrand = null;
            history.pushState({}, '', 'brands.html');
            document.getElementById('brands-view').classList.remove('hidden');
            document.getElementById('brand-detail').classList.add('hidden');
        }

        function sortAndRender() {
            let sorted = [...filteredToys];
            switch (currentSort) {
                case 'price-low': sorted.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0)); break;
                case 'price-high': sorted.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0)); break;
                case 'rating': sorted.sort((a, b) => (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0)); break;
                default: sorted.sort((a, b) => (parseFloat(b.toy_tap_score) || 0) - (parseFloat(a.toy_tap_score) || 0));
            }

            const toShow = sorted.slice(0, visibleCount);
            document.getElementById('showing-count').textContent = toShow.length;

            if (toShow.length === 0) {
                document.getElementById('toy-grid').innerHTML = `<div class="col-span-full text-center py-20 text-white/50">No toys found for this filter</div>`;
                document.getElementById('show-more-btn').classList.add('hidden');
                return;
            }

            document.getElementById('toy-grid').innerHTML = toShow.map(toy => {
                const price = parseFloat(toy.price) || 0;
                const discount = parseFloat(toy.discount_percent) || 0;
                const hasDiscount = discount > 5;
                return `
                    <a href="toy.html?asin=${toy.asin}" class="glass-card rounded-xl overflow-hidden hover:border-primary/30 transition-all block">
                        <div class="relative aspect-square bg-white/5 overflow-hidden">
                            <img src="${toy.image_url_proxied || toy.image_url}" alt="" class="w-full h-full object-contain p-2"/>
                            ${hasDiscount ? `<div class="absolute top-2 left-2 bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-lg">-${discount.toFixed(0)}%</div>` : ''}
                            ${toy.tt_grade ? `<div class="absolute top-2 right-2 bg-primary text-navy-deep text-xs font-bold px-2 py-1 rounded-lg">${toy.tt_grade}</div>` : ''}
                        </div>
                        <div class="p-3 md:p-4">
                            <p class="text-primary text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">${toy.brand || ''}</p>
                            <h3 class="text-white text-sm font-semibold leading-tight mb-2 line-clamp-2 min-h-[2.5rem]">${toy.toy_name}</h3>
                            <div class="flex items-center justify-between">
                                <span class="text-white text-lg font-bold font-mono">$${price.toFixed(2)}</span>
                                ${toy.rating ? `<span class="text-white/50 text-xs">‚≠ê ${parseFloat(toy.rating).toFixed(1)}</span>` : ''}
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            document.getElementById('show-more-btn').classList.toggle('hidden', visibleCount >= sorted.length);
        }

        function handleSortChange() {
            currentSort = document.getElementById('sort-select').value;
            sortAndRender();
        }

        function showMore() {
            visibleCount += 24;
            sortAndRender();
        }

        function getUrlParam(param) {
            return new URLSearchParams(window.location.search).get(param);
        }
    </script>
</body>
</html>
