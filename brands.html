<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Brands - Toy Tap</title>
    <meta name="description" content="Browse toys by brand. LEGO, Fisher-Price, Melissa & Doug, and more." />
    <link rel="icon" type="image/png" href="https://i.imgur.com/HXSawxU.png" />
    <!-- Preconnect for faster resource loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL@24,400,0..1&icon_names=menu,close,favorite,search,arrow_back,shopping_cart,analytics,lock&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3fc3d5",
                        "background-dark": "#0a0e27",
                        "navy-deep": "#0a0e27",
                        "navy-card": "#12183d",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"]
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .cyan-glow { box-shadow: 0 0 20px rgba(63, 195, 213, 0.3); }
        .glass-panel { background: rgba(18, 24, 61, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .glass-card { background: rgba(18, 24, 61, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .filter-tab { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .filter-tab:hover { background: rgba(63,195,213,0.1); color: white; }
        .filter-tab.active { background: linear-gradient(135deg, #3fc3d5, #0a0e27); color: white; border-color: #3fc3d5; }
        .gradient-animate {
            background: linear-gradient(90deg, #3fc3d5, #a855f7, #f59e0b, #3fc3d5);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 6s ease infinite;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Mobile performance */
        @media (max-width: 768px) {
            .glass-panel, .glass-card, .backdrop-blur-md { backdrop-filter: none; -webkit-backdrop-filter: none; }
            .glass-panel, .glass-card { background: rgba(18, 24, 61, 0.95); }
            .gradient-animate { animation: none; background: linear-gradient(90deg, #3fc3d5, #a855f7); background-size: 100% 100%; }
        }
    </style>
</head>
<body class="bg-background-dark font-display text-white min-h-screen">
    <!-- Background Effects -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-primary/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] bg-primary/5 rounded-full blur-[100px]"></div>
    </div>

    <!-- Navigation -->
    <header class="relative z-50 border-b border-white/5 bg-navy-deep/80 backdrop-blur-md sticky top-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8 md:h-10 md:w-10" />
                <span class="text-xl md:text-2xl font-black gradient-animate">Toy Tap</span>
            </a>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-primary" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 hover:text-yellow-300 transition-colors" href="https://gettoytap.com" target="_blank">Partner ‚Üó</a>
            </nav>
            <div class="flex items-center gap-2">
                <div id="nav-auth" class="hidden md:flex items-center gap-2 md:gap-4">
                    <a href="login.html" class="text-sm font-bold text-white/70 hover:text-primary transition-colors px-3 py-2">Login</a>
                    <a href="login.html" class="bg-primary text-navy-deep px-4 md:px-6 py-2.5 rounded-lg font-bold text-sm hover:brightness-110 transition-all">Sign Up</a>
                </div>
                <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="md:hidden p-2 text-white/70 hover:text-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-white/5 bg-navy-deep/95 backdrop-blur-md">
            <nav class="flex flex-col p-4 gap-1">
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-primary py-3 px-4 rounded-lg bg-white/5" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 py-3 px-4 rounded-lg hover:bg-white/5" href="https://gettoytap.com" target="_blank">Partner ‚Üó</a>
                <div class="border-t border-white/10 mt-2 pt-2">
                    <a class="text-sm font-semibold text-primary py-3 px-4 rounded-lg hover:bg-white/5 block" href="login.html">Sign In / Sign Up</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="relative z-10">
        <!-- Hero -->
        <section class="text-center py-12 md:py-16 px-4">
            <h1 class="text-4xl md:text-6xl font-black text-white mb-4">Shop by Brand</h1>
            <p class="text-white/60 text-lg">Browse toys from your favorite brands</p>
        </section>

        <!-- Content Area -->
        <section class="max-w-7xl mx-auto px-4 md:px-6 pb-12">
            <!-- Brand Grid View -->
            <div id="brands-view">
                <div id="brands-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>

            <!-- Brand Detail View -->
            <div id="brand-detail" class="hidden">
                <!-- Brand Header with Logo -->
                <div class="flex items-center justify-between flex-wrap gap-4 mb-6 pb-6 border-b border-white/10">
                    <div class="flex items-center gap-4">
                        <button onclick="showAllBrands()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white/70 hover:bg-primary/20 hover:text-primary transition-all">
                            <span class="material-symbols-outlined text-lg">arrow_back</span> All Brands
                        </button>
                        <h2 id="brand-title" class="text-2xl md:text-3xl font-bold"></h2>
                    </div>
                    <div class="flex gap-6 font-mono">
                        <div class="text-center">
                            <p id="brand-toy-count" class="text-2xl font-bold text-primary">0</p>
                            <p class="text-xs text-white/50">Toys</p>
                        </div>
                        <div class="text-center">
                            <p id="brand-deal-count" class="text-2xl font-bold text-emerald-400">0</p>
                            <p class="text-xs text-white/50">On Sale</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="filter-tab active px-4 py-2 rounded-lg text-sm font-semibold" data-filter="hot" onclick="setFilter('hot')">
                        üî• Hot Now <span id="fresh-count" class="bg-white/20 text-xs px-2 py-0.5 rounded-full ml-1">0</span>
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="picks" onclick="setFilter('picks')">
                        ‚≠ê Toy Tap Picks
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="bestsellers" onclick="setFilter('bestsellers')">
                        üèÜ Best Sellers
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="deals" onclick="setFilter('deals')">
                        üìâ Price Drops
                    </button>
                    <button class="filter-tab px-4 py-2 rounded-lg text-sm font-semibold" data-filter="toprated" onclick="setFilter('toprated')">
                        üëç Top Rated
                    </button>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <p class="text-white/50 text-sm">Showing <span class="text-white font-semibold" id="showing-count">0</span> toys</p>
                    <select id="sort-select" onchange="handleSortChange()" class="bg-navy-card border border-white/10 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-primary cursor-pointer" style="color-scheme: dark;">
                        <option value="score" class="bg-navy-card text-white">Best Value</option>
                        <option value="price-low" class="bg-navy-card text-white">Price: Low to High</option>
                        <option value="price-high" class="bg-navy-card text-white">Price: High to Low</option>
                        <option value="rating" class="bg-navy-card text-white">Highest Rated</option>
                    </select>
                </div>

                <div id="toy-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>

                <div class="text-center mt-10">
                    <button id="show-more-btn" onclick="showMore()" class="hidden bg-white/5 hover:bg-white/10 border border-white/10 text-white font-semibold px-8 py-3 rounded-xl transition-all">
                        Show More
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 bg-navy-deep/40">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-2">
                    <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8" />
                    <span class="text-lg font-bold">Toy Tap</span>
                </div>
                <p class="text-white/30 text-sm">¬© 2025 Toy Tap. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/api.js"></script>
    <script>
        // Auth
        const SUPABASE_URL = 'https://ehuwltjozobbbzsdygbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodXdsdGpvem9iYmJ6c2R5Z2JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjAzNDQsImV4cCI6MjA4MDUzNjM0NH0.xSRT_UkN4RLK40R51mHtksb1u90M8y2FjzS45aXLGSI';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        supabaseClient.auth.getSession().then(({ data }) => {
            if (data?.session) {
                currentUser = data.session.user;
                document.getElementById('nav-auth').innerHTML = `
                    <span class="text-sm text-white/50 hidden md:inline">${currentUser.email}</span>
                    <button onclick="signOut()" class="text-sm font-bold text-white/70 hover:text-red-400 transition-colors px-3 py-2">Sign Out</button>
                `;
            }
        });

        async function signOut() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        // Only brands we actually track (sorted by toy count)
        const TRACKED_BRANDS = [
            { name: 'Melissa & Doug', initials: 'M&D', color: '#e31937' },
            { name: 'Learning Resources', initials: 'LR', color: '#0066b3' },
            { name: 'VTech', initials: 'VT', color: '#e4002b' },
            { name: 'LEGO', initials: 'L', color: '#ffcd00', textColor: '#000' },
            { name: 'Play-Doh', initials: 'PD', color: '#ffd100', textColor: '#000' },
            { name: 'Green Toys', initials: 'GT', color: '#4caf50' },
            { name: 'LeapFrog', initials: 'LF', color: '#7cb342' },
            { name: 'Fisher-Price', initials: 'FP', color: '#e31937' },
            { name: 'PicassoTiles', initials: 'PT', color: '#ff6f00' },
            { name: 'Hape', initials: 'H', color: '#e4002b' },
            { name: 'Skillmatics', initials: 'SK', color: '#6a1b9a' },
            { name: 'KidKraft', initials: 'KK', color: '#f44336' },
            { name: 'Little Tikes', initials: 'LT', color: '#e31937' },
            { name: 'BRIO', initials: 'B', color: '#c62828' },
            { name: 'Step2', initials: 'S2', color: '#1976d2' },
            { name: 'MAGNA-TILES', initials: 'MT', color: '#ff5722' },
            { name: 'Infantino', initials: 'IN', color: '#00bcd4' }
        ];

        let currentBrand = null;
        let brandToys = [];
        let filteredToys = [];
        let visibleCount = 24;
        let currentSort = 'score';
        let currentFilter = 'hot';

        // Non-toy keywords to filter out
        const NON_TOY_KEYWORDS = [
            'water bottle', 'waterbottle', 'lunch box', 'lunchbox', 'lunch bag',
            'backpack', 'bag', 'thermos', 'flask', 'tumbler', 'cup', 'mug',
            'blanket', 'towel', 'pillow', 'bedding', 'sheet', 'curtain',
            'clothing', 'shirt', 't-shirt', 'tshirt', 'pants', 'shorts', 'dress', 'costume',
            'shoes', 'socks', 'slippers', 'hat', 'cap', 'headband',
            'sticker', 'decal', 'poster', 'wall art', 'wall decor',
            'book', 'coloring book', 'activity book', 'storybook',
            'dvd', 'blu-ray', 'video', 'movie',
            'gift card', 'gift wrap', 'wrapping paper',
            'furniture', 'chair', 'table', 'desk', 'shelf', 'storage',
            'rug', 'mat', 'carpet', 'clock', 'lamp', 'light',
            'plate', 'bowl', 'utensil', 'fork', 'spoon', 'knife',
            'toothbrush', 'soap', 'shampoo', 'lotion'
        ];

        // Check if product is a non-toy item
        function isNonToy(toy) {
            if (!toy.toy_name) return false;
            const name = toy.toy_name.toLowerCase();
            return NON_TOY_KEYWORDS.some(keyword => name.includes(keyword));
        }

        // Fresh deal = updated within 48 hours AND has discount (matches Softr logic)
        function isFreshDeal(toy) {
            if (!toy.updated_at) return false;
            const date = new Date(toy.updated_at + (toy.updated_at.includes('Z') ? '' : 'Z'));
            const now = new Date();
            const hoursAgo = (now - date) / (1000 * 60 * 60);
            return hoursAgo < 48 && toy.discount_percent && parseFloat(toy.discount_percent) > 0;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlBrand = getUrlParam('brand');
            if (urlBrand) {
                selectBrand(urlBrand);
            } else {
                renderBrandsGrid();
            }
        });

        function renderBrandsGrid() {
            document.getElementById('brands-grid').innerHTML = TRACKED_BRANDS.map(brand => `
                <button onclick="selectBrand('${brand.name}')" class="glass-card rounded-xl p-4 text-center transition-all duration-200 hover:scale-105 hover:-translate-y-1 hover:border-primary/50 group" style="border-left: 3px solid ${brand.color}">
                    <span class="font-bold text-sm text-white group-hover:text-primary transition-colors">${brand.name}</span>
                </button>
            `).join('');
        }

        // Darken color for shadow
        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        async function selectBrand(brandName) {
            currentBrand = brandName;
            visibleCount = 24;
            currentSort = 'score';
            currentFilter = 'hot';

            // Reset filter tabs
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-filter="hot"]').classList.add('active');

            history.pushState({}, '', `brands.html?brand=${encodeURIComponent(brandName)}`);

            document.getElementById('brands-view').classList.add('hidden');
            document.getElementById('brand-detail').classList.remove('hidden');
            document.getElementById('brand-title').textContent = brandName;

            // Brand info for potential future use
            const brandInfo = TRACKED_BRANDS.find(b => b.name === brandName);

            document.getElementById('toy-grid').innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-20">
                    <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
                    <p class="text-white/50">Loading ${brandName} toys...</p>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/toys/brand/${encodeURIComponent(brandName)}?limit=200&sort=toy_tap_rank`);
                const data = await res.json();
                // Filter out non-toy items (water bottles, lunch boxes, etc.)
                brandToys = (data.toys || []).filter(toy => !isNonToy(toy));

                document.getElementById('brand-toy-count').textContent = brandToys.length;
                document.getElementById('brand-deal-count').textContent = brandToys.filter(t => parseFloat(t.discount_percent) > 10).length;

                applyFilterAndRender();
            } catch (err) {
                console.error('Error loading brand:', err);
                document.getElementById('toy-grid').innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <p class="text-red-400 mb-4">Failed to load toys</p>
                        <button onclick="selectBrand('${brandName}')" class="bg-primary text-navy-deep px-6 py-2 rounded-lg font-semibold">Retry</button>
                    </div>
                `;
            }
        }

        function setFilter(filter) {
            console.log('setFilter called:', filter);
            currentFilter = filter;
            visibleCount = 24;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.filter === filter);
            });

            applyFilterAndRender();
        }

        // Each filter has its own default sort to make tabs feel different
        const FILTER_SORTS = {
            hot: 'recency',      // Most recently updated first
            picks: 'grade',      // Best TT Grade first
            bestsellers: 'reviews', // Most reviews first
            deals: 'discount',   // Biggest discount first
            toprated: 'rating'   // Highest rating first
        };

        function applyFilterAndRender() {
            console.log('applyFilterAndRender, currentFilter:', currentFilter, 'brandToys:', brandToys.length);

            // Apply filter
            switch (currentFilter) {
                case 'hot':
                    // Hot Now: Fresh deals (updated <48hrs + on sale)
                    filteredToys = brandToys.filter(t => isFreshDeal(t));
                    if (filteredToys.length === 0) filteredToys = brandToys.filter(t => parseFloat(t.discount_percent) > 0);
                    break;
                case 'picks':
                    // Toy Tap Picks: High TT Grade (S, A+, A)
                    filteredToys = brandToys.filter(t => t.tt_grade && ['S', 'A+', 'A'].includes(t.tt_grade));
                    if (filteredToys.length === 0) filteredToys = [...brandToys];
                    break;
                case 'bestsellers':
                    // Best Sellers: All toys (will be sorted by reviews)
                    filteredToys = [...brandToys];
                    break;
                case 'deals':
                    // Price Drops: Has discount > 5%
                    filteredToys = brandToys.filter(t => parseFloat(t.discount_percent) > 5);
                    if (filteredToys.length === 0) filteredToys = brandToys.filter(t => parseFloat(t.discount_percent) > 0);
                    break;
                case 'toprated':
                    // Top Rated: High rating (4.5+) with decent reviews (50+)
                    filteredToys = brandToys.filter(t => parseFloat(t.rating) >= 4.5 && parseInt(t.reviews_count) >= 50);
                    if (filteredToys.length === 0) filteredToys = brandToys.filter(t => parseFloat(t.rating) >= 4.0);
                    if (filteredToys.length === 0) filteredToys = [...brandToys];
                    break;
                default:
                    filteredToys = [...brandToys];
            }

            console.log('After filter:', filteredToys.length, 'toys');

            // Update fresh count badge
            const freshCount = brandToys.filter(t => isFreshDeal(t)).length;
            const freshCountEl = document.getElementById('fresh-count');
            if (freshCountEl) freshCountEl.textContent = freshCount;

            // Apply filter-specific default sort
            applyFilterSort();
            renderToys();
        }

        function applyFilterSort() {
            const sortType = FILTER_SORTS[currentFilter] || 'score';
            switch (sortType) {
                case 'recency':
                    filteredToys.sort((a, b) => new Date(b.updated_at || 0) - new Date(a.updated_at || 0));
                    break;
                case 'grade':
                    const gradeOrder = { 'S': 6, 'A+': 5, 'A': 4, 'B+': 3, 'B': 2, 'C+': 1, 'C': 0, 'D': -1 };
                    filteredToys.sort((a, b) => (gradeOrder[b.tt_grade] || -2) - (gradeOrder[a.tt_grade] || -2));
                    break;
                case 'reviews':
                    filteredToys.sort((a, b) => (parseInt(b.reviews_count) || 0) - (parseInt(a.reviews_count) || 0));
                    break;
                case 'discount':
                    filteredToys.sort((a, b) => (parseFloat(b.discount_percent) || 0) - (parseFloat(a.discount_percent) || 0));
                    break;
                case 'rating':
                    filteredToys.sort((a, b) => (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0));
                    break;
                default:
                    filteredToys.sort((a, b) => (parseFloat(b.toy_tap_score) || 0) - (parseFloat(a.toy_tap_score) || 0));
            }
        }

        function renderToys() {
            const toShow = filteredToys.slice(0, visibleCount);
            document.getElementById('showing-count').textContent = toShow.length;

            if (toShow.length === 0) {
                document.getElementById('toy-grid').innerHTML = `<div class="col-span-full text-center py-20 text-white/50">No toys found for this filter</div>`;
                document.getElementById('show-more-btn').classList.add('hidden');
                return;
            }

            document.getElementById('toy-grid').innerHTML = toShow.map(toy => {
                const price = parseFloat(toy.price) || 0;
                const discount = parseFloat(toy.discount_percent) || 0;
                const hasDiscount = discount > 5;
                return `
                    <a href="toy.html?asin=${toy.asin}" class="glass-card rounded-xl overflow-hidden hover:border-primary/30 transition-all block">
                        <div class="relative aspect-square bg-white/5 overflow-hidden">
                            <img src="${toy.image_url_proxied || toy.image_url}" alt="" loading="lazy" class="w-full h-full object-contain p-2"/>
                            ${hasDiscount ? `<div class="absolute top-2 left-2 bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-lg">-${discount.toFixed(0)}%</div>` : ''}
                            ${toy.tt_grade ? `<div class="absolute top-2 right-2 bg-primary text-navy-deep text-xs font-bold px-2 py-1 rounded-lg">${toy.tt_grade}</div>` : ''}
                        </div>
                        <div class="p-3 md:p-4">
                            <p class="text-primary text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">${toy.brand || ''}</p>
                            <h3 class="text-white text-sm font-semibold leading-tight mb-2 line-clamp-2 min-h-[2.5rem]">${toy.toy_name}</h3>
                            <div class="flex items-center justify-between">
                                <span class="text-white text-lg font-bold font-mono">$${price.toFixed(2)}</span>
                                ${toy.rating ? `<span class="text-white/50 text-xs">‚≠ê ${parseFloat(toy.rating).toFixed(1)}</span>` : ''}
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            document.getElementById('show-more-btn').classList.toggle('hidden', visibleCount >= filteredToys.length);
        }

        function showAllBrands() {
            currentBrand = null;
            history.pushState({}, '', 'brands.html');
            document.getElementById('brands-view').classList.remove('hidden');
            document.getElementById('brand-detail').classList.add('hidden');
        }

        function handleSortChange() {
            const sortVal = document.getElementById('sort-select').value;
            switch (sortVal) {
                case 'price-low':
                    filteredToys.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
                    break;
                case 'price-high':
                    filteredToys.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0));
                    break;
                case 'rating':
                    filteredToys.sort((a, b) => (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0));
                    break;
                default:
                    // Reset to filter's default sort
                    applyFilterSort();
            }
            renderToys();
        }

        function showMore() {
            visibleCount += 24;
            renderToys();
        }

        function getUrlParam(param) {
            return new URLSearchParams(window.location.search).get(param);
        }
    </script>
</body>
</html>
