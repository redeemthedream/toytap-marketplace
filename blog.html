<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Blog - Toy Tap</title>
    <meta name="description" content="Toy guides, deals roundups, and shopping tips from Toy Tap." />
    <link rel="icon" type="image/png" href="https://i.imgur.com/HXSawxU.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3fc3d5",
                        "background-dark": "#0a0e27",
                        "navy-deep": "#0a0e27",
                        "navy-card": "#12183d",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"]
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .gradient-animate {
            background: linear-gradient(90deg, #3fc3d5, #a855f7, #f59e0b, #3fc3d5);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 6s ease infinite;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-panel { background: rgba(18, 24, 61, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .glass-card { background: rgba(18, 24, 61, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(63, 195, 213, 0.1); }
        @media (max-width: 768px) {
            .glass-panel, .glass-card { backdrop-filter: none; background: rgba(18, 24, 61, 0.95); }
            .gradient-animate { animation: none; background: linear-gradient(90deg, #3fc3d5, #a855f7); background-size: 100% 100%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        }
    </style>
</head>
<body class="bg-background-dark font-display text-white min-h-screen">
    <!-- Background Effects -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-primary/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] bg-primary/5 rounded-full blur-[100px]"></div>
    </div>

    <!-- Navigation -->
    <header class="relative z-50 border-b border-white/5 bg-navy-deep/80 backdrop-blur-md sticky top-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8 md:h-10 md:w-10" />
                <span class="text-xl md:text-2xl font-black gradient-animate">Toy Tap</span>
            </a>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-primary" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 hover:text-yellow-300 transition-colors" href="https://gettoytap.com" target="_blank">Partner ↗</a>
            </nav>
            <div class="flex items-center gap-2">
                <div id="nav-auth" class="hidden md:flex items-center gap-2 md:gap-4">
                    <a href="login.html" class="text-sm font-bold text-white/70 hover:text-primary transition-colors px-3 py-2">Login</a>
                    <a href="login.html" class="bg-primary text-navy-deep px-4 md:px-6 py-2.5 rounded-lg font-bold text-sm hover:brightness-110 transition-all">Sign Up</a>
                </div>
                <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="md:hidden p-2 text-white/70 hover:text-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-white/5 bg-navy-deep/95 backdrop-blur-md">
            <nav class="flex flex-col p-4 gap-1">
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-primary py-3 px-4 rounded-lg bg-white/5" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 py-3 px-4 rounded-lg hover:bg-white/5" href="https://gettoytap.com" target="_blank">Partner ↗</a>
                <div class="border-t border-white/10 mt-2 pt-2">
                    <a class="text-sm font-semibold text-primary py-3 px-4 rounded-lg hover:bg-white/5 block" href="login.html">Sign In / Sign Up</a>
                </div>
            </nav>
        </div>
    </header>

<main class="relative z-10">
    <!-- Hero -->
    <section class="text-center py-12 md:py-16 px-4">
        <h1 class="text-4xl md:text-6xl font-black text-white mb-4">Toy Tap Blog</h1>
        <p class="text-white/60 text-lg">Guides, deal roundups, and shopping tips</p>
    </section>

    <!-- Filter Pills -->
    <div class="flex flex-wrap gap-2 justify-center px-4 mb-8 max-w-2xl mx-auto">
        <button class="filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-primary text-navy-deep" data-filter="all" onclick="filterPosts('all')">All</button>
        <button class="filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-white/10 text-white/70 hover:bg-primary/20 hover:text-primary" data-filter="deals" onclick="filterPosts('deals')">Deals</button>
        <button class="filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-white/10 text-white/70 hover:bg-primary/20 hover:text-primary" data-filter="guides" onclick="filterPosts('guides')">Guides</button>
        <button class="filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-white/10 text-white/70 hover:bg-primary/20 hover:text-primary" data-filter="reviews" onclick="filterPosts('reviews')">Reviews</button>
    </div>

    <!-- Blog Grid -->
    <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto px-4 pb-12">
        <!-- Posts loaded from Supabase -->
    </div>

    <!-- Trending Toys Section -->
    <section class="max-w-6xl mx-auto px-4 py-8">
        <h2 class="text-2xl font-bold text-white mb-6">Trending Toys Right Now</h2>
        <div id="trending-toys" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <!-- Loaded by JS -->
        </div>
    </section>
</main>

<!-- Footer -->
<footer class="border-t border-white/5 bg-navy-deep/40 mt-12">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-2">
                <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8" />
                <span class="text-lg font-bold">Toy Tap</span>
            </div>
            <div class="flex items-center gap-6 text-sm text-white/40">
                <a href="https://gettoytap.com" class="hover:text-primary transition-colors">For Businesses</a>
                <a href="https://gettoytap.com/privacy" class="hover:text-primary transition-colors">Privacy</a>
            </div>
            <p class="text-white/30 text-sm">© 2025 Toy Tap. All rights reserved.</p>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/api.js"></script>
<script>
// Supabase config
const SUPABASE_URL = 'https://ehuwltjozobbbzsdygbo.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodXdsdGpvem9iYmJ6c2R5Z2JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjAzNDQsImV4cCI6MjA4MDUzNjM0NH0.xSRT_UkN4RLK40R51mHtksb1u90M8y2FjzS45aXLGSI';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let POSTS = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', async () => {
    await loadPosts();
    await loadTrendingToys();
});

// Fetch first toy image from API endpoint
async function getToyImage(apiEndpoint) {
    if (!apiEndpoint) return null;
    try {
        const response = await fetch('https://hub.gettoytap.com' + apiEndpoint);
        const data = await response.json();
        const toys = data.toys || data || [];
        if (toys.length > 0) {
            return toys[0].image_url_proxied || toys[0].image_url || null;
        }
    } catch (err) {
        console.error('Error fetching toy image:', err);
    }
    return null;
}

async function loadTrendingToys() {
    try {
        const response = await fetch('https://hub.gettoytap.com/toys/leaderboard?limit=8');
        const data = await response.json();
        const toys = data.toys || data || [];

        document.getElementById('trending-toys').innerHTML = toys.map(toy => {
            const price = parseFloat(toy.price) || 0;
            const discount = parseFloat(toy.discount_percent) || 0;
            const imageUrl = toy.image_url_proxied || toy.image_url || '';

            return `
                <a href="toy.html?asin=${toy.asin}" class="glass-card rounded-xl overflow-hidden hover:border-primary/30 transition-all block">
                    <div class="relative aspect-square bg-white/5">
                        <img src="${imageUrl}" alt="${toy.toy_name}" class="w-full h-full object-contain p-2"/>
                        ${discount > 5 ? `<div class="absolute top-2 left-2 bg-emerald-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">-${discount.toFixed(0)}%</div>` : ''}
                    </div>
                    <div class="p-2.5">
                        <p class="text-primary text-[9px] font-bold uppercase truncate">${toy.brand || ''}</p>
                        <h3 class="text-white text-xs font-semibold truncate">${toy.toy_name}</h3>
                        <p class="text-white text-sm font-bold font-mono">$${price.toFixed(2)}</p>
                    </div>
                </a>
            `;
        }).join('');
    } catch (err) {
        console.error('Error loading trending toys:', err);
    }
}

async function loadPosts() {
    document.getElementById('blog-grid').innerHTML = '<p style="text-align:center;color:#94a3b8;padding:40px;">Loading posts...</p>';

    try {
        let { data, error } = await supabaseClient
            .from('blog_posts')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading posts:', error);
            document.getElementById('blog-grid').innerHTML = '<p style="text-align:center;color:#f87171;padding:40px;">Failed to load posts. Table might be named differently.</p>';
            return;
        }

        POSTS = data || [];
        console.log('Loaded posts:', POSTS);
        renderPosts();
    } catch (err) {
        console.error('Error:', err);
        document.getElementById('blog-grid').innerHTML = '<p style="text-align:center;color:#f87171;padding:40px;">Error loading posts</p>';
    }
}

function filterPosts(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-pill').forEach(p => {
        const isActive = p.dataset.filter === filter;
        if (isActive) {
            p.className = 'filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-primary text-navy-deep';
        } else {
            p.className = 'filter-pill px-5 py-2.5 rounded-full text-sm font-semibold transition-all bg-white/10 text-white/70 hover:bg-primary/20 hover:text-primary';
        }
    });
    renderPosts();
}

// Category-based images
const CATEGORY_IMAGES = {
    'deals': [
        'https://images.unsplash.com/photo-1558060370-d644479cb6f7?w=400',
        'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=400',
        'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=400'
    ],
    'guides': [
        'https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=400',
        'https://images.unsplash.com/photo-1566576912321-d58ddd7a6088?w=400',
        'https://images.unsplash.com/photo-1596461404969-9ae70f2830c1?w=400'
    ],
    'reviews': [
        'https://images.unsplash.com/photo-1594787318286-3d835c1d207f?w=400',
        'https://images.unsplash.com/photo-1558060370-d644479cb6f7?w=400',
        'https://images.unsplash.com/photo-1545558014-8692077e9b5c?w=400'
    ],
    'lego': [
        'https://images.unsplash.com/photo-1587654780291-39c9404d746b?w=400',
        'https://images.unsplash.com/photo-1585366119957-e9730b6d0f60?w=400',
        'https://images.unsplash.com/photo-1560961911-ba7ef651a56c?w=400'
    ],
    'default': [
        'https://images.unsplash.com/photo-1558060370-d644479cb6f7?w=400',
        'https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=400',
        'https://images.unsplash.com/photo-1594787318286-3d835c1d207f?w=400'
    ]
};

function getCategoryImage(category, index) {
    const cat = (category || 'default').toLowerCase();
    const images = CATEGORY_IMAGES[cat] || CATEGORY_IMAGES.default;
    return images[index % images.length];
}

async function renderPosts() {
    const filtered = currentFilter === 'all' ? POSTS : POSTS.filter(p => (p.category || '').toLowerCase() === currentFilter);

    if (filtered.length === 0) {
        document.getElementById('blog-grid').innerHTML = '<p style="text-align:center;color:#94a3b8;padding:40px;">No posts found</p>';
        return;
    }

    // Fetch toy images for each post
    const postsWithImages = await Promise.all(filtered.map(async (post) => {
        const toyImage = await getToyImage(post.api_endpoint);
        return { ...post, toyImage };
    }));

    document.getElementById('blog-grid').innerHTML = postsWithImages.map((post) => {
        const title = post.title || 'Untitled';
        const slug = post.slug || post.id;
        const category = post.category || 'Article';
        const image = post.toyImage || 'https://images.unsplash.com/photo-1558060370-d644479cb6f7?w=400';
        const excerpt = post.intro_text || post.excerpt || post.summary || '';
        const date = post.created_at ? new Date(post.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';

        return `
            <div onclick="window.location='post.html?slug=${slug}'" class="glass-card rounded-xl overflow-hidden cursor-pointer hover:border-primary/30 transition-all hover:-translate-y-1">
                <div class="bg-white h-44 flex items-center justify-center p-4">
                    <img src="${image}" alt="${title}" class="max-h-full max-w-full object-contain" />
                </div>
                <div class="p-5">
                    <div class="text-primary text-xs font-bold uppercase tracking-wider mb-2">${category}</div>
                    <h2 class="text-white text-lg font-bold mb-2 line-clamp-2">${title}</h2>
                    <p class="text-white/50 text-sm line-clamp-2 mb-3">${excerpt}</p>
                    <div class="text-white/30 text-xs">${date}</div>
                </div>
            </div>
        `;
    }).join('');
}
</script>
</body>
</html>
