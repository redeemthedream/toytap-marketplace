<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="page-title">Toy Details - Toy Tap</title>
    <meta name="description" content="View price history, analytics, and deal analysis for this toy on Toy Tap." />
    <link rel="icon" type="image/png" href="https://i.imgur.com/HXSawxU.png" />
    <!-- Preconnect for faster resource loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL@20..48,100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3fc3d5",
                        "background-dark": "#0a0e27",
                        "navy-deep": "#0a0e27",
                        "navy-card": "#12183d",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"]
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .cyan-glow { box-shadow: 0 0 20px rgba(63, 195, 213, 0.3); }
        .glass-panel { background: rgba(18, 24, 61, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .glass-card { background: rgba(18, 24, 61, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(63, 195, 213, 0.1); }
        .gradient-animate {
            background: linear-gradient(90deg, #3fc3d5, #a855f7, #f59e0b, #3fc3d5);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 6s ease infinite;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Mobile performance */
        @media (max-width: 768px) {
            .glass-panel, .glass-card, .backdrop-blur-md, [class*="backdrop-blur"] { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
            .glass-panel, .glass-card { background: rgba(18, 24, 61, 0.95); }
            .gradient-animate { animation: none; background: linear-gradient(90deg, #3fc3d5, #a855f7); background-size: 100% 100%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
            /* Hide expensive blur backgrounds on mobile */
            .blur-\[120px\], .blur-\[100px\] { display: none !important; }
        }
        /* Better touch responsiveness */
        button, a, [onclick] { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-background-dark font-display text-white min-h-screen">
    <!-- Background Effects -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-primary/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] left-[-5%] w-[400px] h-[400px] bg-primary/5 rounded-full blur-[100px]"></div>
    </div>

    <!-- Navigation -->
    <header class="relative z-50 border-b border-white/5 bg-navy-deep/80 backdrop-blur-md sticky top-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8 md:h-10 md:w-10" />
                <span class="text-xl md:text-2xl font-black gradient-animate">Toy Tap</span>
            </a>
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 hover:text-primary transition-colors" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 hover:text-yellow-300 transition-colors" href="https://gettoytap.com" target="_blank">Partner ↗</a>
            </nav>
            <div class="flex items-center gap-2">
                <div id="nav-auth" class="hidden md:flex items-center gap-2 md:gap-4">
                    <a href="login.html" class="text-sm font-bold text-white/70 hover:text-primary transition-colors px-3 py-2">Login</a>
                    <a href="login.html" class="bg-primary text-navy-deep px-4 md:px-6 py-2.5 rounded-lg font-bold text-sm hover:brightness-110 transition-all">Sign Up</a>
                </div>
                <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="md:hidden p-2 text-white/70 hover:text-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-white/5 bg-navy-deep/95 backdrop-blur-md">
            <nav class="flex flex-col p-4 gap-1">
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="index.html">Home</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="rankings.html">Rankings</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="brands.html">Brands</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="blog.html">Blog</a>
                <a class="text-sm font-semibold text-white/70 py-3 px-4 rounded-lg hover:bg-white/5" href="watchlist.html">Watchlist</a>
                <a class="text-sm font-semibold text-yellow-400 py-3 px-4 rounded-lg hover:bg-white/5" href="https://gettoytap.com" target="_blank">Partner ↗</a>
                <div class="border-t border-white/10 mt-2 pt-2">
                    <a class="text-sm font-semibold text-primary py-3 px-4 rounded-lg hover:bg-white/5 block" href="login.html">Sign In / Sign Up</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="relative z-10">
        <div class="max-w-5xl mx-auto px-4 py-6 md:py-10">
            <!-- Back Link -->
            <a href="index.html" class="inline-flex items-center gap-2 text-primary font-semibold mb-6 hover:opacity-80 transition-opacity">
                <span class="material-symbols-outlined">arrow_back</span> Back to Deals
            </a>

            <!-- Loading State -->
            <div id="loading" class="text-center py-32">
                <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/50">Loading toy details...</p>
            </div>

            <!-- Content (hidden until loaded) -->
            <div id="content" class="hidden">
                <!-- Product Hero -->
                <div class="glass-panel rounded-2xl p-4 md:p-8 mb-6">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-10">
                        <!-- Image -->
                        <div class="relative shrink-0 mx-auto md:mx-0">
                            <img id="product-image" class="w-48 h-48 md:w-72 md:h-72 object-contain bg-white rounded-2xl" src="" alt="">
                            <div id="product-badges" class="absolute top-3 left-3 flex flex-col gap-2"></div>
                        </div>

                        <!-- Details -->
                        <div class="flex-1">
                            <p id="product-brand" class="text-primary text-xs md:text-sm font-bold uppercase tracking-wider mb-2"></p>
                            <h1 id="product-name" class="text-xl md:text-3xl font-bold text-white mb-6 leading-tight"></h1>

                            <!-- Metrics Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">TT Grade</p>
                                    <p class="text-xl md:text-2xl font-bold font-mono" id="metric-grade">--</p>
                                </div>
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">TT Score</p>
                                    <p class="text-xl md:text-2xl font-bold font-mono text-yellow-400" id="metric-score">--</p>
                                </div>
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">Rating</p>
                                    <p class="text-xl md:text-2xl font-bold font-mono" id="metric-rating">--</p>
                                </div>
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">Reviews</p>
                                    <p class="text-xl md:text-2xl font-bold font-mono text-primary" id="metric-reviews">--</p>
                                </div>
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">Amazon Rank</p>
                                    <p class="text-xl md:text-2xl font-bold font-mono text-orange-400" id="metric-rank">#--</p>
                                </div>
                                <div class="glass-card rounded-xl p-3 md:p-4 text-center">
                                    <p class="text-[10px] md:text-xs text-white/50 uppercase mb-1">Category</p>
                                    <p class="text-sm md:text-base font-semibold text-white/70 truncate" id="metric-category">--</p>
                                </div>
                            </div>

                            <!-- Price Section -->
                            <div class="bg-gradient-to-r from-primary/10 to-yellow-500/10 rounded-xl p-4 md:p-6">
                                <div class="flex items-baseline gap-3 mb-2">
                                    <span class="text-3xl md:text-5xl font-black font-mono text-white" id="current-price">$0.00</span>
                                    <span class="text-lg md:text-xl text-white/40 line-through hidden" id="original-price">$0.00</span>
                                </div>
                                <div id="savings-badge" class="hidden inline-block bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold">
                                    Save 0%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Stats -->
                <div class="grid grid-cols-3 gap-3 md:gap-4 mb-6">
                    <div class="glass-card rounded-xl p-4 md:p-6 text-center border-emerald-500/30">
                        <p class="text-xs text-white/50 uppercase mb-2">Lowest Price</p>
                        <p class="text-xl md:text-3xl font-bold font-mono text-emerald-400" id="stat-lowest">--</p>
                        <p class="text-[10px] md:text-xs text-white/40 mt-1" id="stat-lowest-note">All time low</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 md:p-6 text-center">
                        <p class="text-xs text-white/50 uppercase mb-2">Average Price</p>
                        <p class="text-xl md:text-3xl font-bold font-mono text-white" id="stat-average">--</p>
                        <p class="text-[10px] md:text-xs text-white/40 mt-1">90-day average</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 md:p-6 text-center border-red-500/30">
                        <p class="text-xs text-white/50 uppercase mb-2">Highest Price</p>
                        <p class="text-xl md:text-3xl font-bold font-mono text-red-400" id="stat-highest">--</p>
                        <p class="text-[10px] md:text-xs text-white/40 mt-1">All time high</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="glass-panel rounded-2xl p-4 md:p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <h3 class="text-lg md:text-xl font-bold">Price & Rank History</h3>
                        <div class="flex gap-2">
                            <button class="period-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white/5 border border-white/10 text-white/50 hover:bg-primary/20 hover:text-primary transition-all" data-days="30" onclick="setPeriod(30)">30D</button>
                            <button class="period-btn px-4 py-2 rounded-lg text-sm font-semibold bg-primary text-navy-deep" data-days="90" onclick="setPeriod(90)">90D</button>
                            <button class="period-btn px-4 py-2 rounded-lg text-sm font-semibold bg-white/5 border border-white/10 text-white/50 hover:bg-primary/20 hover:text-primary transition-all" data-days="365" onclick="setPeriod(365)">1Y</button>
                        </div>
                    </div>

                    <!-- Price Chart -->
                    <div class="glass-card rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-semibold text-white">Price History</span>
                            <span class="flex items-center gap-2 text-xs text-white/50">
                                <span class="w-3 h-3 rounded bg-orange-500"></span> Amazon Price
                            </span>
                        </div>
                        <div class="h-48 md:h-56">
                            <canvas id="price-chart"></canvas>
                        </div>
                    </div>

                    <!-- Amazon Rank Chart -->
                    <div class="glass-card rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-semibold text-white">Amazon Best Seller Rank</span>
                            <span class="flex items-center gap-2 text-xs text-white/50">
                                <span class="w-3 h-3 rounded bg-emerald-500"></span> Lower is better
                            </span>
                        </div>
                        <div class="h-48 md:h-56">
                            <canvas id="amazon-rank-chart"></canvas>
                        </div>
                    </div>

                    <!-- Toy Tap Rank -->
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-semibold text-white">Toy Tap Global Rank</span>
                            <span class="flex items-center gap-2 text-xs text-white/50">
                                <span class="w-3 h-3 rounded bg-primary"></span> Current ranking
                            </span>
                        </div>
                        <div class="text-center py-6">
                            <p class="text-5xl md:text-6xl font-black font-mono text-primary mb-2" id="toytap-rank-value">#--</p>
                            <p class="text-white/50 text-sm">out of 20,000+ toys tracked</p>
                            <p class="text-white/30 text-xs mt-2">Based on TT Grade score combining reviews, ratings, and popularity</p>
                        </div>
                    </div>
                </div>

                <!-- Deal Analysis -->
                <div class="glass-panel rounded-2xl p-4 md:p-6 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl" id="deal-indicator">
                            &#128176;
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-bold mb-1" id="deal-title">Checking deal...</h3>
                            <p class="text-white/50 text-sm" id="deal-description">Analyzing current price against historical data.</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <a id="buy-amazon" href="#" target="_blank" class="flex-1 flex items-center justify-center gap-3 bg-orange-500 hover:bg-orange-400 text-white py-4 px-6 rounded-xl font-bold text-base transition-all">
                        <span class="material-symbols-outlined">shopping_cart</span> Buy on Amazon
                    </a>
                    <button onclick="addToWatchlist()" id="watchlist-btn" class="flex-1 flex items-center justify-center gap-3 bg-white/5 hover:bg-primary/20 border border-white/10 hover:border-primary/30 text-white py-4 px-6 rounded-xl font-bold text-base transition-all">
                        <span class="material-symbols-outlined" id="watchlist-icon">bookmark_add</span>
                        <span id="watchlist-text">Add to Watchlist</span>
                    </button>
                </div>

                <!-- Affiliate Disclosure -->
                <p class="text-center text-white/30 text-xs leading-relaxed">
                    Toy Tap participates in the Amazon Associates program. We may earn commissions on qualifying purchases at no extra cost to you. Prices update every 24 hours.
                </p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden text-center py-32">
                <div class="text-5xl mb-4">&#128533;</div>
                <p class="text-red-400 text-lg mb-6">Could not load toy details</p>
                <a href="index.html" class="inline-block bg-primary text-navy-deep px-6 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
                    Browse Toys
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 bg-navy-deep/40 mt-auto">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-2">
                    <img src="https://i.imgur.com/HXSawxU.png" alt="Toy Tap" class="h-8 w-8" />
                    <span class="text-lg font-bold">Toy Tap</span>
                </div>
                <p class="text-white/30 text-sm">© 2025 Toy Tap. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        const SUPABASE_URL = 'https://ehuwltjozobbbzsdygbo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodXdsdGpvem9iYmJ6c2R5Z2JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjAzNDQsImV4cCI6MjA4MDUzNjM0NH0.xSRT_UkN4RLK40R51mHtksb1u90M8y2FjzS45aXLGSI';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let priceChart = null;
        let amazonRankChart = null;
        let priceHistory = [];
        let priceStats = {};
        let dealAnalysis = {};
        let currentPeriod = 90;
        let toyData = null;
        let currentUser = null;
        let watchlist = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth
            try {
                const { data } = await supabaseClient.auth.getSession();
                if (data?.session) {
                    currentUser = data.session.user;
                    updateNavAuth();
                    loadWatchlist();
                }
            } catch (e) {
                console.log('Auth check failed:', e);
            }

            const asin = getUrlParam('asin');
            if (!asin) {
                console.error('No ASIN provided');
                showError();
                return;
            }

            console.log('Loading toy:', asin);

            try {
                // Fetch price history first (this has all the data we need)
                const priceData = await fetchPriceHistory(asin);
                console.log('Price data:', priceData);

                if (!priceData || !priceData.toy) {
                    console.error('No toy data in response');
                    showError();
                    return;
                }

                // Try to get additional data but don't fail if it doesn't work
                let fullToyData = {};
                try {
                    fullToyData = await fetchToyByAsin(asin) || {};
                } catch (e) {
                    console.log('Could not fetch additional toy data:', e);
                }

                toyData = {
                    ...priceData.toy,
                    tt_grade: fullToyData.tt_grade || priceData.toy.tt_grade,
                    tt_grade_score: fullToyData.tt_grade_score || priceData.toy.tt_grade_score,
                    category_toytap: fullToyData.category_toytap || priceData.toy.category_toytap,
                    discount_percent: fullToyData.discount_percent || priceData.toy.discount_percent,
                    compare_price: fullToyData.compare_price || priceData.toy.compare_price,
                    is_lowest_price_ever: fullToyData.is_lowest_price_ever || priceData.toy.is_lowest_price_ever,
                    toy_tap_rank_global: fullToyData.toy_tap_rank_global || priceData.toy.toy_tap_rank_global
                };
                priceStats = priceData.price_stats || {};
                dealAnalysis = priceData.deal_analysis || {};
                priceHistory = priceData.price_history || [];

                renderProduct();
                renderCharts();
                renderDealAnalysis();
                updateWatchlistButton();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            } catch (err) {
                console.error('Load error:', err);
                showError();
            }
        });

        function updateNavAuth() {
            if (currentUser) {
                document.getElementById('nav-auth').innerHTML = `
                    <span class="text-sm text-white/50 hidden md:inline">${currentUser.email}</span>
                    <a href="watchlist.html" class="text-sm font-bold text-primary hover:brightness-110 transition-colors px-3 py-2">Watchlist</a>
                `;
            }
        }

        // Listen for auth state changes (handles Google OAuth redirects)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session && !currentUser) {
                currentUser = session.user;
                updateNavAuth();
                loadWatchlist();
            } else if (!session && currentUser) {
                currentUser = null;
                window.location.reload();
            }
        });

        function loadWatchlist() {
            if (currentUser) {
                const saved = localStorage.getItem('toytap_watchlist_' + currentUser.id);
                watchlist = saved ? JSON.parse(saved) : [];
            }
        }

        function updateWatchlistButton() {
            if (!toyData) return;
            const isInWatchlist = watchlist.find(t => t.asin === toyData.asin);
            const icon = document.getElementById('watchlist-icon');
            const text = document.getElementById('watchlist-text');
            if (isInWatchlist) {
                icon.textContent = 'bookmark_added';
                text.textContent = 'In Watchlist';
            } else {
                icon.textContent = 'bookmark_add';
                text.textContent = 'Add to Watchlist';
            }
        }

        window.addToWatchlist = function() {
            if (!currentUser) {
                window.location.href = 'login.html?redirect=toy.html?asin=' + toyData.asin;
                return;
            }
            const isInWatchlist = watchlist.find(t => t.asin === toyData.asin);
            if (isInWatchlist) {
                watchlist = watchlist.filter(t => t.asin !== toyData.asin);
            } else {
                watchlist.push(toyData);
            }
            localStorage.setItem('toytap_watchlist_' + currentUser.id, JSON.stringify(watchlist));
            updateWatchlistButton();
        };

        async function fetchToyByAsin(asin) {
            try {
                if (window.toyCache && window.toyCache[asin]) {
                    return window.toyCache[asin];
                }
                const res = await fetch(`${API_BASE}/toys/search?q=${asin}&limit=5`);
                const data = await res.json();
                if (data.toys && data.toys.length > 0) {
                    const match = data.toys.find(t => t.asin === asin);
                    if (match) return match;
                }
                return {};
            } catch (err) {
                console.error('Fetch toy error:', err);
                return {};
            }
        }

        function renderProduct() {
            const toy = toyData;

            document.getElementById('page-title').textContent = `${toy.toy_name} - Toy Tap`;
            document.getElementById('product-image').src = toy.image_url_proxied || toy.image_url || PLACEHOLDER_IMG;
            document.getElementById('product-brand').textContent = toy.brand || 'Unknown Brand';
            document.getElementById('product-name').textContent = toy.toy_name;

            // Metrics
            const ttGrade = toy.tt_grade || '--';
            if (ttGrade && ttGrade !== '--') {
                document.getElementById('metric-grade').innerHTML = `<span class="text-primary">${ttGrade}</span>`;
            } else {
                document.getElementById('metric-grade').textContent = '--';
            }
            document.getElementById('metric-score').textContent = toy.toy_tap_score ? parseFloat(toy.toy_tap_score).toFixed(1) : '--';
            document.getElementById('metric-rating').innerHTML = `${toy.rating || 'N/A'} <span class="text-yellow-400">&#9733;</span>`;
            document.getElementById('metric-reviews').textContent = (toy.reviews_count || 0).toLocaleString();

            const rank = parseInt(toy.rank) || 0;
            if (rank > 0) {
                document.getElementById('metric-rank').textContent = formatRank(rank);
            }

            const category = toy.category_toytap || toy.category || '--';
            document.getElementById('metric-category').textContent = category;

            // Current price
            const price = parseFloat(priceStats.current) || parseFloat(toy.price) || 0;
            document.getElementById('current-price').textContent = '$' + price.toFixed(2);

            // Discount and badges
            const previousPrice = parseFloat(priceStats.previous) || 0;
            const discount = dealAnalysis.vs_previous ? Math.abs(dealAnalysis.vs_previous.change_percent) : 0;
            const isLowestEver = dealAnalysis.vs_historical?.is_near_low || false;
            let badgesHtml = '';

            if (discount > 5 && previousPrice > price) {
                document.getElementById('original-price').textContent = '$' + previousPrice.toFixed(2);
                document.getElementById('original-price').classList.remove('hidden');
                document.getElementById('savings-badge').textContent = `Save ${discount.toFixed(0)}%`;
                document.getElementById('savings-badge').classList.remove('hidden');
                badgesHtml += `<div class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-lg">-${discount.toFixed(0)}%</div>`;
            }

            if (isLowestEver) {
                badgesHtml += `<div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-navy-deep text-xs font-bold px-2 py-1 rounded-lg uppercase">Lowest Ever</div>`;
            }

            document.getElementById('product-badges').innerHTML = badgesHtml;

            // Buy link
            document.getElementById('buy-amazon').href = toy.affiliate_url || `https://amazon.com/dp/${toy.asin}?tag=redeemer0d0-20`;

            // Price stats
            if (priceStats.lowest !== undefined) {
                document.getElementById('stat-lowest').textContent = '$' + parseFloat(priceStats.lowest).toFixed(2);
                document.getElementById('stat-highest').textContent = '$' + parseFloat(priceStats.highest).toFixed(2);
                document.getElementById('stat-average').textContent = '$' + parseFloat(priceStats.average).toFixed(2);

                if (price <= priceStats.lowest * 1.05) {
                    document.getElementById('stat-lowest-note').innerHTML = '<span class="text-emerald-400">&#10003; At lowest!</span>';
                }
            }
        }

        function formatRank(rank) {
            if (rank >= 1000000) {
                return '#' + (rank / 1000000).toFixed(1) + 'M';
            } else if (rank >= 1000) {
                return '#' + (rank / 1000).toFixed(1) + 'K';
            }
            return '#' + rank;
        }

        function renderCharts() {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - currentPeriod);

            const filteredHistory = priceHistory.filter(h => {
                if (!h.date) return true;
                return new Date(h.date) >= cutoffDate;
            });

            const labels = filteredHistory.map(h => {
                if (!h.date) return '';
                const d = new Date(h.date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            if (priceChart) priceChart.destroy();
            if (amazonRankChart) amazonRankChart.destroy();

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', maxTicksLimit: 8 }
                    }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            };

            // Price Chart
            const priceCtx = document.getElementById('price-chart').getContext('2d');
            const amazonPrices = filteredHistory.map(h => h.price);
            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Price',
                        data: amazonPrices,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#12183d',
                            titleColor: '#fff',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(63,195,213,0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => context.raw ? 'Price: $' + context.raw.toFixed(2) : ''
                            }
                        }
                    },
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#64748b',
                                callback: (value) => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });

            // Amazon Rank Chart
            const rankCtx = document.getElementById('amazon-rank-chart').getContext('2d');
            const ranks = filteredHistory.map(h => h.rank || null);
            amazonRankChart = new Chart(rankCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Amazon Rank',
                        data: ranks,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#12183d',
                            titleColor: '#fff',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(63,195,213,0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => context.raw ? 'Rank: #' + context.raw.toLocaleString() : ''
                            }
                        }
                    },
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            reverse: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#64748b',
                                callback: (value) => '#' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Toy Tap Rank Display
            const toytapRank = toyData.toy_tap_rank_global || toyData.tt_rank || null;
            const rankEl = document.getElementById('toytap-rank-value');
            if (toytapRank) {
                rankEl.textContent = '#' + toytapRank.toLocaleString();
            } else {
                rankEl.textContent = 'N/A';
            }
        }

        function setPeriod(days) {
            currentPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.days) === days;
                btn.classList.toggle('bg-primary', isActive);
                btn.classList.toggle('text-navy-deep', isActive);
                btn.classList.toggle('bg-white/5', !isActive);
                btn.classList.toggle('text-white/50', !isActive);
                btn.classList.toggle('border', !isActive);
                btn.classList.toggle('border-white/10', !isActive);
            });
            renderCharts();
        }

        function renderDealAnalysis() {
            const indicator = document.getElementById('deal-indicator');
            const title = document.getElementById('deal-title');
            const desc = document.getElementById('deal-description');

            const recommendation = dealAnalysis.recommendation || '';
            const isNearLow = dealAnalysis.vs_historical?.is_near_low || false;
            const vsHighestPercent = dealAnalysis.vs_historical?.vs_highest_percent || 0;
            const changePercent = dealAnalysis.vs_previous?.change_percent || 0;

            if (recommendation.includes('Excellent') || isNearLow) {
                indicator.className = 'w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-emerald-500/20';
                indicator.innerHTML = '&#129321;';
                title.textContent = 'Great Deal!';
                desc.textContent = recommendation || `Near all-time low price. This is a great time to buy!`;
            } else if (recommendation.includes('Good') || Math.abs(vsHighestPercent) > 30) {
                indicator.className = 'w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-emerald-500/20';
                indicator.innerHTML = '&#128077;';
                title.textContent = 'Good Deal';
                desc.textContent = recommendation || `Price is well below the highest. Solid deal.`;
            } else if (changePercent < -10) {
                indicator.className = 'w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-red-500/20';
                indicator.innerHTML = '&#128528;';
                title.textContent = 'Above Average';
                desc.textContent = 'Current price is higher than recent history. Consider waiting.';
            } else {
                indicator.className = 'w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-yellow-500/20';
                indicator.innerHTML = '&#128578;';
                title.textContent = 'Average Price';
                desc.textContent = recommendation || 'Price is close to the historical average.';
            }
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }
    </script>
</body>
</html>
